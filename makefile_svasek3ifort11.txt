#F77 = mpif90 -fdefault-real-8 -fdefault-double-8 -ffixed-line-length-132 -fbacktrace -Ofast
F77 = mpif90 -autodouble -132 -traceback -O5 -opt-malloc-options=4 -heap-arrays 10 # -axcore-avx2,avx

FLAGS =  
LIBS2 = -L/usr/local/netcdf/netcdf-4.1.3/lib -lnetcdff -lnetcdf  

topdir = /usr/local/mumps/4.10.0
libdir = $(topdir)/lib

include ./install_Makefile_new.inc

#MKLROOT= /usr/local/intel/compiler15_official/composer_xe_2015.3.187/mkl
MKLROOT= /usr/local/intel/compiler11_official/11.1/072
MKLPATH=$MKLROOT/lib/em64t
MKLINCLUDE=$MKLROOT/include
LIBMKL = -L$MKLPATH -lmkl_intel_lp64 -lmkl_intel_thread -lmkl_core -liomp5 -lpthread
 
LIBMUMPS_COMMON = $(libdir)/libmumps_common$(PLAT)$(LIBEXT)
LIBDMUMPS = $(libdir)/libdmumps$(PLAT)$(LIBEXT) $(LIBMUMPS_COMMON)


FC = $(F77) $(FLAGS)
RM = rm -f

# commandos to obtain svn info in fortran program:
VR1 = $(shell echo "      svnversion = '`svnversion`'" > version.inc)
VR2 = #$(shell echo "      svnurl = '`svn info | grep URL`'" >> version.inc )


PROGRAM = TUDflow3d_svasek_vg.exe

SRCS    = error_functions.f nlist.f extra_functions.f sediment.f advec.f advec_compact4knikker.f advec_cds6.f advec_hybrid4.f advec_hybrid6.f advec_c4a6.f diff_compact.f bound.f init.f main.f sparse_matrix.f solve.f turbulence_models.f vfft.f output.f 

OBJS    = error_functions.o nlist.o extra_functions.o sediment.o advec.o advec_compact4knikker.o advec_cds6.o advec_hybrid4.o advec_hybrid6.o advec_c4a6.o diff_compact.o bound.o init.o main.o sparse_matrix.o solve.o output.o turbulence_models.o vfft.o 

all: $(PROGRAM)

$(PROGRAM): $(OBJS)
	$(F77) $(FLAGS) -o $(PROGRAM) $(OBJS) $(LIBS2) $(LIBDMUMPS) $(LORDERINGS) $(LIBS) $(LIBBLAS) $(LIBMETIS5) $(LIBOTHERS) $(LIBMKL)
	


###########################
main.o: main.f makefile
	$(F77) $(FLAGS) -c main.f

vfft.o: vfft.f makefile
	$(F77) $(FLAGS) -c vfft.f

sediment.o: sediment.f makefile
	$(F77) $(FLAGS) -c sediment.f

error_functions.o: error_functions.f makefile
	$(F77) $(FLAGS) -c error_functions.f

turbulence_models.o: turbulence_models.f makefile
	$(F77) $(FLAGS) -c turbulence_models.f

nlist.o: nlist.f makefile	
	$(F77) $(FLAGS) -c nlist.f

advec.o: advec.f makefile	
	$(F77) $(FLAGS) -c advec.f

advec_compact4knikker.o: advec_compact4knikker.f makefile	
	$(F77) $(FLAGS) -c advec_compact4knikker.f

advec_cds6.o: advec_cds6.f makefile	
	$(F77) $(FLAGS) -c advec_cds6.f

advec_hybrid4.o: advec_hybrid4.f makefile	
	$(F77) $(FLAGS) -c advec_hybrid4.f

advec_hybrid6.o: advec_hybrid6.f makefile	
	$(F77) $(FLAGS) -c advec_hybrid6.f
	
advec_a4c6.o: advec_c4a6.f makefile	
	$(F77) $(FLAGS) -c advec_c4a6.f	

diff_compact.o: diff_compact.f makefile	
	$(F77) $(FLAGS) -c diff_compact.f

output.o: output.f makefile	
	$(F77) $(FLAGS) -c -I/usr/local/netcdf/netcdf-4.1.3/include output.f

extra_functions.o: extra_functions.f makefile
	$(F77) $(FLAGS) -c -I/usr/local/netcdf/netcdf-4.1.3/include extra_functions.f

bound.o: bound.f makefile	
	$(F77) $(FLAGS) -c bound.f

init.o: init.f makefile	
	$(F77) $(FLAGS) -c -I/usr/local/netcdf/netcdf-4.1.3/include init.f

sparse_matrix.o: sparse_matrix.f makefile	
	$(F77) $(FLAGS) -c -I$(topdir)/include sparse_matrix.f
	
solve.o: solve.f makefile	
	$(F77) $(FLAGS) -I$MKLINCLUDE -c solve.f
	


clean:
	$(RM) a.out core *.mod $(PROGRAM) $(OBJS)

version: $(VR1) $(VR2) 
